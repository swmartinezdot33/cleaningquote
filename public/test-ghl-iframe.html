<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Local iframe test – CleanQuote</title>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, sans-serif; background: #f9fafb; color: #111827; min-height: 100vh; }

    /* GHL-like layout: sidebar + main */
    .app-shell { display: flex; min-height: 100vh; }
    .sidebar {
      width: 240px; min-width: 240px; background: #f3f4f6; border-right: 1px solid #e5e7eb;
      display: flex; flex-direction: column; flex-shrink: 0;
    }
    .sidebar-brand { padding: 16px; border-bottom: 1px solid #e5e7eb; }
    .sidebar-brand .logo { font-weight: 700; font-size: 1.1rem; color: #6d28d9; }
    .sidebar-brand .logo span { color: #111827; }
    .sidebar-location { margin-top: 8px; font-size: 0.8rem; color: #6b7280; }
    .sidebar-location input { width: 100%; padding: 6px 8px; margin-top: 4px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.8rem; }
    .sidebar-nav { flex: 1; padding: 12px 0; overflow-y: auto; }
    .sidebar-nav a, .sidebar-nav .nav-item {
      display: flex; align-items: center; gap: 10px; padding: 10px 16px; color: #374151; text-decoration: none; font-size: 0.9rem;
      border-left: 3px solid transparent; cursor: pointer;
    }
    .sidebar-nav a:hover, .sidebar-nav .nav-item:hover { background: #e5e7eb; color: #111827; }
    .sidebar-nav a.active, .sidebar-nav .nav-item.active { background: #ede9fe; color: #6d28d9; border-left-color: #6d28d9; font-weight: 500; }
    .sidebar-settings { padding: 12px 16px; border-top: 1px solid #e5e7eb; }
    .sidebar-settings a { color: #6b7280; text-decoration: none; font-size: 0.875rem; display: flex; align-items: center; gap: 8px; }
    .sidebar-settings a:hover { color: #111827; }
    .sidebar .load-row { padding: 12px 16px; }
    .sidebar .load-row input { width: 100%; padding: 6px 8px; margin-bottom: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.8rem; }
    .sidebar .load-row label { font-size: 0.75rem; color: #6b7280; display: block; margin-bottom: 2px; }
    .sidebar .load-row button { width: 100%; padding: 8px 12px; background: #6d28d9; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 0.875rem; }
    .sidebar .load-row button:hover { background: #5b21b6; }

    .main { flex: 1; display: flex; flex-direction: column; min-width: 0; }
    .topbar {
      height: 56px; background: #fff; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: space-between; padding: 0 24px; flex-shrink: 0;
    }
    .topbar-left { display: flex; align-items: center; gap: 12px; }
    .topbar .logo-text { font-weight: 700; font-size: 1.1rem; color: #111827; }
    .topbar .logo-text .purple { color: #6d28d9; }
    .topbar-right { display: flex; align-items: center; gap: 16px; }
    .topbar .btn-new { padding: 8px 16px; background: #6d28d9; color: #fff; border: none; border-radius: 8px; font-weight: 500; font-size: 0.875rem; cursor: pointer; }
    .topbar .btn-new:hover { background: #5b21b6; }
    .subnav {
      background: #fff; border-bottom: 1px solid #e5e7eb; padding: 0 24px; display: flex; align-items: center; gap: 4px; flex-shrink: 0;
    }
    .subnav a, .subnav .subnav-item {
      padding: 14px 12px; font-size: 0.875rem; color: #6b7280; text-decoration: none; border-bottom: 2px solid transparent; margin-bottom: -1px; cursor: pointer;
    }
    .subnav a:hover, .subnav .subnav-item:hover { color: #111827; }
    .subnav a.active, .subnav .subnav-item.active { color: #6d28d9; font-weight: 600; border-bottom-color: #6d28d9; }
    .content { flex: 1; display: flex; flex-direction: column; padding: 0; min-height: 0; overflow: hidden; }
    .content-header { margin-bottom: 16px; }
    .content-header h1 { font-size: 1.5rem; font-weight: 700; margin: 0 0 4px 0; color: #111827; }
    .content-header p { font-size: 0.875rem; color: #6b7280; margin: 0; }
    .iframe-wrap { flex: 1; min-height: 0; background: #fff; overflow: hidden; display: flex; flex-direction: column; }
    .iframe-wrap.hidden { display: none; }
    .iframe-placeholder { flex: 1; min-height: 0; display: flex; align-items: center; justify-content: center; background: #f9fafb; color: #6b7280; font-size: 0.9rem; padding: 24px; text-align: center; }
    .iframe-placeholder.hidden { display: none; }
    #appFrame { width: 100%; height: 100%; flex: 1; min-height: 0; border: 0; display: block; }
    .hint { font-size: 0.75rem; color: #9ca3af; margin-top: 4px; }
  </style>
</head>
<body>
  <div class="app-shell">
    <aside class="sidebar">
      <div class="sidebar-brand">
        <div class="logo">Clean<span>Quote</span>.io</div>
        <div class="sidebar-location">
          <label for="locationId">Location ID</label>
          <input type="text" id="locationId" placeholder="e.g. tCqS9npFPtO0…">
        </div>
        <div class="sidebar-location" style="margin-top:10px">
          <label for="base">App base URL</label>
          <input type="text" id="base" placeholder="http://localhost:3000">
        </div>
      </div>
      <div class="load-row">
        <button type="button" id="load">Load app in iframe</button>
      </div>
      <nav class="sidebar-nav" id="sidebarNav">
        <a href="#" data-page="/dashboard" class="nav-item active">Dashboard</a>
        <a href="#" data-page="/dashboard/quotes" class="nav-item">Quotes</a>
        <a href="#" data-page="/dashboard/crm" class="nav-item">Leads</a>
        <a href="#" data-page="/dashboard/crm/contacts" class="nav-item">Contacts</a>
        <a href="#" data-page="/dashboard/crm/inbox" class="nav-item">Inbox</a>
        <a href="#" data-page="/dashboard/tools" class="nav-item">Tools</a>
        <a href="#" data-page="/dashboard/service-areas" class="nav-item">Service Areas</a>
        <a href="#" data-page="/dashboard/pricing-structures" class="nav-item">Pricing</a>
      </nav>
      <div class="sidebar-settings">
        <a href="#">Settings</a>
      </div>
    </aside>
    <div class="main">
      <header class="topbar"></header>
      <main class="content">
        <div class="iframe-wrap hidden" id="frameWrap">
          <div class="iframe-placeholder hidden" id="iframePlaceholder">Loading…</div>
          <iframe id="appFrame" title="CleanQuote" allow="clipboard-write"></iframe>
        </div>
        <div class="iframe-placeholder" id="initialPlaceholder">
          <div>
            <p><strong>Local iframe test</strong></p>
            <p>Enter your <strong>Location ID</strong> and <strong>App base URL</strong> in the left sidebar, then click <strong>Load app in iframe</strong>.</p>
            <p class="hint">Location ID is sent via postMessage so the app receives context the same way as in production.</p>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script>
    function getBase() { return (document.getElementById('base').value || '').replace(/\/$/, ''); }
    function getLocationId() { return (document.getElementById('locationId').value || '').trim(); }
    function getPath() { return window._currentPath || '/dashboard'; }
    function setPath(path) {
      window._currentPath = path || '/dashboard';
      document.querySelectorAll('.sidebar-nav .nav-item').forEach(function (el) {
        var isActive = (el.getAttribute('data-page') === window._currentPath);
        el.classList.toggle('active', isActive);
      });
    }
    function getIframeUrl() { return getBase() + getPath(); }
    function sendPostMessage() {
      var locationId = getLocationId();
      if (!locationId) return;
      var iframe = document.getElementById('appFrame');
      if (!iframe || !iframe.contentWindow) return;
      try {
        var targetOrigin = getBase();
        var payload = { locationId: locationId };
        var msg = { message: 'REQUEST_USER_DATA_RESPONSE', payload: payload };
        iframe.contentWindow.postMessage(msg, targetOrigin);
        console.log('[test-ghl-iframe] postMessage sent', { targetOrigin: targetOrigin, locationId: locationId.slice(0, 8) + '...' });
      } catch (e) { console.warn('[test-ghl-iframe] postMessage error', e); }
    }
    function loadIframe() {
      var locationId = getLocationId();
      if (!locationId) { alert('Enter a Location ID'); return; }
      var base = getBase();
      if (!base) { alert('Enter App base URL (e.g. http://localhost:3000)'); return; }
      var iframe = document.getElementById('appFrame');
      var wrap = document.getElementById('frameWrap');
      var initial = document.getElementById('initialPlaceholder');
      var url = getIframeUrl();
      iframe.src = url;
      wrap.classList.remove('hidden');
      initial.classList.add('hidden');
      iframe.onload = function () {
        sendPostMessage();
        setTimeout(sendPostMessage, 200);
        setTimeout(sendPostMessage, 600);
      };
    }
    function navigateTo(path) {
      if (!path) return;
      setPath(path);
      var wrap = document.getElementById('frameWrap');
      if (wrap.classList.contains('hidden')) return;
      var iframe = document.getElementById('appFrame');
      iframe.src = getIframeUrl();
      iframe.onload = function () {
        sendPostMessage();
        setTimeout(sendPostMessage, 200);
      };
    }
    document.getElementById('load').onclick = loadIframe;
    document.querySelectorAll('.sidebar-nav .nav-item').forEach(function (a) {
      a.addEventListener('click', function (e) { e.preventDefault(); navigateTo(a.getAttribute('data-page')); });
    });
    (function () {
      var baseEl = document.getElementById('base');
      if (baseEl && !baseEl.value && typeof window !== 'undefined' && window.location.origin) {
        baseEl.value = window.location.origin;
      }
    })();
    setPath('/dashboard');
  </script>
</body>
</html>
