<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Local iframe test – CleanQuote</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 920px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
    .card { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,.1); margin-bottom: 20px; }
    label { display: block; margin-bottom: 6px; font-weight: 600; }
    input[type="text"], select { width: 100%; padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
    select { margin-top: 4px; cursor: pointer; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end; }
    .row > * { flex: 1 1 auto; min-width: 140px; }
    button { padding: 10px 16px; background: #2563eb; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; }
    button:hover { background: #1d4ed8; }
    iframe { width: 100%; height: 72vh; border: 1px solid #ddd; border-radius: 6px; background: #fff; }
    .hint { font-size: 0.875rem; color: #666; margin-top: 8px; }
    code { background: #f0f0f0; padding: 2px 6px; border-radius: 4px; }
    .url-preview { font-size: 0.8rem; color: #555; word-break: break-all; margin-top: 8px; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Local iframe test</h1>
    <p>Test CleanQuote locally by <strong>mimicking postMessage</strong>: the app is loaded in an iframe with <em>no</em> URL params. This window sends a postMessage with the location ID so the app receives context the same way it does in production.</p>
    <label for="base">App base URL</label>
    <input type="text" id="base" value="http://localhost:3000" placeholder="http://localhost:3000">
    <label for="locationId" style="margin-top:12px">Location ID</label>
    <input type="text" id="locationId" placeholder="e.g. tCqS9npFPtO0DSuYVvzb" value="">
    <p class="hint">Your sub-account location ID (case-sensitive).</p>
    <label for="page" style="margin-top:12px">Initial page</label>
    <select id="page">
      <option value="/dashboard">Dashboard</option>
      <option value="/dashboard/crm">Leads</option>
      <option value="/dashboard/quotes">Quotes</option>
      <option value="/dashboard/crm/contacts">Contacts</option>
      <option value="/dashboard/tools">Tools</option>
      <option value="/dashboard/service-areas">Service Areas</option>
      <option value="/dashboard/pricing-structures">Pricing</option>
    </select>
    <div class="row" style="margin-top:16px; gap:8px;">
      <button type="button" id="load">Load app in iframe + send postMessage</button>
    </div>
    <p class="url-preview" id="urlPreview"></p>
  </div>
  <div class="card" id="frameWrap" style="display:none">
    <h2>App (iframe)</h2>
    <iframe id="appFrame" title="CleanQuote"></iframe>
  </div>

  <script>
    function getBase() { return (document.getElementById('base').value || '').replace(/\/$/, ''); }
    function getLocationId() { return (document.getElementById('locationId').value || '').trim(); }
    function getPath() { return (document.getElementById('page').value || '/dashboard'); }
    function getIframeUrl() {
      var base = getBase();
      var path = getPath();
      return base + path;
    }
    function updatePreview() {
      document.getElementById('urlPreview').textContent = 'Iframe URL (no params): ' + getIframeUrl() + ' — locationId is sent via postMessage.';
    }
    function loadIframe() {
      var locationId = getLocationId();
      if (!locationId) {
        alert('Enter a Location ID');
        return;
      }
      var iframe = document.getElementById('appFrame');
      var base = getBase();
      var url = getIframeUrl();
      iframe.src = url;
      document.getElementById('frameWrap').style.display = 'block';
      updatePreview();

      function sendPostMessage() {
        try {
          var targetOrigin = base;
          var payload = { locationId: locationId };
          var msg = { message: 'REQUEST_USER_DATA_RESPONSE', payload: payload };
          iframe.contentWindow.postMessage(msg, targetOrigin);
          console.log('[test-ghl-iframe] postMessage sent', { targetOrigin, locationId: locationId.slice(0, 8) + '...' });
        } catch (e) {
          console.warn('[test-ghl-iframe] postMessage error', e);
        }
      }
      iframe.onload = function () {
        sendPostMessage();
        setTimeout(sendPostMessage, 200);
        setTimeout(sendPostMessage, 600);
      };
    }
    document.getElementById('load').onclick = loadIframe;
    document.getElementById('base').oninput = updatePreview;
    document.getElementById('locationId').oninput = updatePreview;
    document.getElementById('page').onchange = updatePreview;
    updatePreview();
  </script>
</body>
</html>
